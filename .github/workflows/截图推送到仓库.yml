name: Get Video Screenshot

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'ğŸ”— è¾“å…¥YouTubeè§†é¢‘é“¾æ¥'
        required: true
        default: 'https://youtu.be/sample_video'
      enable_sections:
        description: |
          âœ‚ï¸ æƒ³ä¸‹è½½YouTubeè§†é¢‘çš„ç‰‡æ®µå—ï¼Ÿé€‰â€œæ˜¯â€å°±èƒ½è®¾ç½®å¼€å§‹å’Œç»“æŸæ—¶é—´ã€‚ä½ å¯ä»¥ç”¨å°æ—¶:åˆ†é’Ÿ:ç§’.æ¯«ç§’ï¼ˆæ¯”å¦‚ï¼š01:23:45.678ï¼‰ï¼Œåˆ†é’Ÿ:ç§’.æ¯«ç§’ï¼Œç§’.æ¯«ç§’ï¼Œç”šè‡³ç›´æ¥å†™ç§’ï¼ˆæ¯”å¦‚ï¼š12345ï¼‰æ¥è¡¨ç¤ºæ—¶é—´ã€‚å¼€å§‹æ—¶é—´å†™0å°±æ˜¯ä»å¤´å¼€å§‹ã€‚ç»“æŸæ—¶é—´ä¸èƒ½è¶…è¿‡æˆ–ç­‰äºè§†é¢‘æ€»é•¿åº¦ã€‚ å¦‚æœä»¥è§†é¢‘æ€»é•¿åº¦ä½œä¸ºç»“æŸæ—¶é—´ï¼Œæœ€å¥½ç¨å¾®æå‰ä¸€ç‚¹ï¼ˆæ¯”å¦‚å°‘0.5ç§’ï¼‰ï¼Œä»¥é¿å…ä¸‹è½½å‡ºé”™ã€‚ yt-dlpä¼šå°½é‡ç²¾ç¡®åˆ†å‰²ï¼Œä½†ç”±äºè§†é¢‘æ ¼å¼ç­‰åŸå› ï¼Œå®é™…ä¸‹è½½çš„ç‰‡æ®µå¯èƒ½ä¸è®¾ç½®çš„æ—¶é—´ç•¥æœ‰å·®å¼‚ã€‚æƒ³ä¸‹è½½YouTubeä¸Šä¸€ä¸ª5åˆ†é’Ÿçš„æç¬‘è§†é¢‘çš„å‰30ç§’ï¼Œå¯ä»¥è®¾ç½®å¼€å§‹æ—¶é—´ä¸º0ï¼Œç»“æŸæ—¶é—´ä¸º0:30ã€‚å¦‚æœæƒ³ä¸‹è½½å30ç§’ï¼Œå¯ä»¥è®¾ç½®å¼€å§‹æ—¶é—´ä¸º4:30ï¼Œç»“æŸæ—¶é—´ä¸º4:59.5ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥è½»æ¾åœ°ä¸‹è½½è‡ªå·±å–œæ¬¢çš„YouTubeè§†é¢‘ç‰‡æ®µäº†ã€‚
        required: false
        type: choice
        options: 
          - 'No'
          - 'Yes'
        default: 'No'
      start_time:
        description: 'âœ‚ï¸ å¼€å§‹æ—¶é—´'
        required: false
        default: '0:00'
      end_time:
        description: 'âœ‚ï¸ ç»“æŸæ—¶é—´'
        required: false
        default: '2:00'
      upload_artifact:
        description: 'ğŸ“¤ æ˜¯å¦è¦å°†ä¸‹è½½çš„è§†é¢‘ä¸Šä¼ ä¸ºArtifactï¼Ÿ'
        required: false
        type: choice
        options:
          - 'Yes'
          - 'No'
        default: 'Yes'
      view_screenshot:
        description: |
          ğŸ–¼ï¸ æ˜¯å¦è¦æŸ¥çœ‹è§†é¢‘æˆªå›¾ï¼Ÿ
          å¦‚æœé€‰æ‹©"Yes"ï¼Œæˆªå›¾å°†ä¿å­˜åˆ°ä»“åº“æ ¹ç›®å½•ï¼Œæ–‡ä»¶åä¸º"screenshot.png"ã€‚
        required: false
        type: choice
        options:
          - 'Yes'
          - 'No'
        default: 'No'
      media_quality:
        description: 'â–¶ï¸ é€‰æ‹©åª’ä½“è´¨é‡é€‰é¡¹ï¼ˆæ³¨æ„ï¼šé€‰æ‹©åŒ…å«è§†é¢‘å’ŒéŸ³é¢‘çš„é€‰é¡¹ä¼šå°†æµåˆå¹¶ä¸ºå¸¦æœ‰å£°éŸ³çš„å®Œæ•´è§†é¢‘ã€‚ä»…è§†é¢‘è¡¨ç¤ºæ²¡æœ‰éŸ³é¢‘ï¼Œä»…éŸ³é¢‘è¡¨ç¤ºæ²¡æœ‰å›¾åƒã€‚æ‰€æœ‰åª’ä½“éƒ½å°†ä»¥æœ€ä½³å¯ç”¨è´¨é‡ä¸‹è½½ï¼‰ã€‚'
        required: false
        type: choice
        options:
          - '8K Video + Audio'
          - '8K Video Only'
          - '4K Video + Audio (default)'
          - '4K Video Only'
          - '1440p Video + Audio'
          - '1440p Video Only'
          - '1080p Video + Audio'
          - '1080p Video Only'
          - '720p Video + Audio'
          - '720p Video Only'
          - 'Audio Only'
        default: '4K Video + Audio (default)'

jobs:
  get_screenshot:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Install yt-dlp and ffmpeg
        run: |
          pip install yt-dlp
          sudo apt-get update && sudo apt-get install -y ffmpeg
      
      - name: Download selected media type
        run: |
          COOKIES=$(cat <<EOF
          # Netscape HTTP Cookie File
          # This file is generated by yt-dlp.  Do not edit.
          
          .youtube.com	TRUE	/	FALSE	1790407599	APISID	DgYvOOQKlw7h1_8Q/AAGRKC7MKiD__hmR5
          .youtube.com	TRUE	/	FALSE	1790407599	HSID	A29n9-aq9ok17ohwv
          .youtube.com	TRUE	/	TRUE	1758578796	LOGIN_INFO	AFmmF2swRQIhAP6azagS6hbbqZvl9x5hZo9KFdcZ1Om81JriVkoOLPLfAiAigy9mG7_0gGrPLtLV6mADHFIhDzCLizTip_9sz72Feg:QUQ3MjNmeXFXdWVkN1ZuQ1VBT1NUOVJmWGRIZ1RxUGRHd0VhOUpGSWFOdmRCVVlsdUdmd1ZockVZc2ZvcTVkTlZSdVFLZnhqWEZTdmVqSXEtRjdncVRFUVJrMEFGYUU2NjUxZ0VGTG9IUDI1aGV4QWNuT21fY3pzaEhsbTNIS1dlOF9md01Fc3J5VlhibjZiRDBscV8xMGJFWGFRWmloQ1Zn
          .youtube.com	TRUE	/	FALSE	0	PREF	tz=UTC&f4=4000000&f5=30000&hl=en
          .youtube.com	TRUE	/	TRUE	1790407599	SAPISID	JNf6kWbVNoLW2zuP/A0sSKsxaZTogaF-TO
          .youtube.com	TRUE	/	FALSE	1790407599	SID	g.a000oQiM80_qGHnbZB9T4Wy03ZXWW1wEZEHoFBjj8sgOcARcJtVQjhwDBaDshxFo_UoJY_CuxAACgYKAVgSARcSFQHGX2MiTgzyxijZzYHHHXGzt4woLBoVAUF8yKotoPqxqWVExT24ebMSvj0c0076
          .youtube.com	TRUE	/	FALSE	1758901557	SIDCC	AKEyXzVglPMunvSehjmJ8DfqAvRKz-uAPzteXch06Qhf8xeA05ZXkET5YP7JDZ7lDqGoWibpj9Y
          .youtube.com	TRUE	/	TRUE	1790407599	SSID	AElyTLfeX7flrXXc3
          .youtube.com	TRUE	/	TRUE	1739570722	VISITOR_INFO1_LIVE	bX3M9ZU2b1k
          .youtube.com	TRUE	/	TRUE	1739570722	VISITOR_PRIVACY_METADATA	CgJVUxIEGgAgFA%3D%3D
          .youtube.com	TRUE	/	TRUE	0	YSC	9FMpuBmL0Ss
          .youtube.com	TRUE	/	TRUE	1790407599	__Secure-1PAPISID	JNf6kWbVNoLW2zuP/A0sSKsxaZTogaF-TO
          .youtube.com	TRUE	/	TRUE	1790407599	__Secure-1PSID	g.a000oQiM80_qGHnbZB9T4Wy03ZXWW1wEZEHoFBjj8sgOcARcJtVQriZ4BdZ94dve67WUAXhiZwACgYKASwSARcSFQHGX2MiUppqFWl3DqM3T_-rmf3YdxoVAUF8yKoWGI_WQXB9c1gHd_kx4spr0076
          .youtube.com	TRUE	/	TRUE	1758901557	__Secure-1PSIDCC	AKEyXzUp0acgDO7ZsH0xu8rk0id_ah84kIjuK_KyFuaZ86Sm8Q1f5pUheYNrADOy9wbagQj6syg
          .youtube.com	TRUE	/	TRUE	1755555440	__Secure-1PSIDTS	sidts-CjABUFGohyYDRsIY1drC57B6ZRGHEfZBMEkOkgbLhcUgQMkEExnqHUsMQaGvT2cYtXAQAA
          .youtube.com	TRUE	/	TRUE	1790407599	__Secure-3PAPISID	JNf6kWbVNoLW2zuP/A0sSKsxaZTogaF-TO
          .youtube.com	TRUE	/	TRUE	1790407599	__Secure-3PSID	g.a000oQiM80_qGHnbZB9T4Wy03ZXWW1wEZEHoFBjj8sgOcARcJtVQXxqIhrsWCSrJOJRx6ZfrkQACgYKAdoSARcSFQHGX2Mi4GbPZaghrjP_9YBSS0T-DhoVAUF8yKrUAWbUbViaK647iBumpSJ-0076
          .youtube.com	TRUE	/	TRUE	1758901557	__Secure-3PSIDCC	AKEyXzV_OzpFFbxEvWBf_tKh5-A6W835qIhT5LATGsdMavAwb7oKNN3sYa08v0U74T6MzrwfVJs
          .youtube.com	TRUE	/	TRUE	1755555440	__Secure-3PSIDTS	sidts-CjABUFGohyYDRsIY1drC57B6ZRGHEfZBMEkOkgbLhcUgQMkEExnqHUsMQaGvT2cYtXAQAA
          EOF
          )

          echo "$COOKIES" > cookies.txt
          yt-dlp --cookies cookies.txt -F ${{ github.event.inputs.video_url }}
          echo -e "\033[33m---------------------------------------------------------------------------------------\033[0m"
          yt-dlp --cookies cookies.txt --concurrent-fragments 10 \
          $([[ "${{ github.event.inputs.media_quality }}" == "8K Video + Audio" ]] && echo "-f bestvideo+bestaudio") \
          $([[ "${{ github.event.inputs.media_quality }}" == "8K Video Only" ]] && echo "-f bestvideo") \
          $([[ "${{ github.event.inputs.media_quality }}" == "4K Video + Audio (default)" ]] && echo "-f bestvideo[ext=webm]+bestaudio") \
          $([[ "${{ github.event.inputs.media_quality }}" == "4K Video Only" ]] && echo "-f bestvideo[ext=webm]") \
          $([[ "${{ github.event.inputs.media_quality }}" == "1440p Video Only" ]] && echo "-f bestvideo[height<=1440]") \
          $([[ "${{ github.event.inputs.media_quality }}" == "1440p Video + Audio" ]] && echo "-f bestvideo[height<=1440]+bestaudio") \
          $([[ "${{ github.event.inputs.media_quality }}" == "1080p Video Only" ]] && echo "-f bestvideo[height<=1080]") \
          $([[ "${{ github.event.inputs.media_quality }}" == "1080p Video + Audio" ]] && echo "-f bestvideo[height<=1080]+bestaudio") \
          $([[ "${{ github.event.inputs.media_quality }}" == "720p Video Only" ]] && echo "-f bestvideo[height<=720]") \
          $([[ "${{ github.event.inputs.media_quality }}" == "720p Video + Audio" ]] && echo "-f bestvideo[height<=720]+bestaudio") \
          $([[ "${{ github.event.inputs.media_quality }}" == "Audio Only" ]] && echo "-f bestaudio") \
          $([[ "${{ github.event.inputs.enable_sections }}" == "Yes" ]] && echo "--download-sections *${{ github.event.inputs.start_time }}-${{ github.event.inputs.end_time }}") \
          -o "media_output.webm" \
          ${{ github.event.inputs.video_url }} 

      - name: Upload video as artifact
        if: ${{ github.event.inputs.upload_artifact == 'Yes' }}
        uses: actions/upload-artifact@v4
        with:
          name: media
          path: media_output.webm
      
      - name: Capture screenshot at 5 seconds
        if: ${{ github.event.inputs.view_screenshot == 'Yes' && github.event.inputs.media_quality != 'Audio Only' }}
        run: ffmpeg -i media_output.webm -ss 5 -vframes 1 -y screenshot.png

      - name: Configure Git
        if: ${{ github.event.inputs.view_screenshot == 'Yes' && github.event.inputs.media_quality != 'Audio Only' }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit and push screenshot to repository
        if: ${{ github.event.inputs.view_screenshot == 'Yes' && github.event.inputs.media_quality != 'Audio Only' }}
        run: |
          git add screenshot.png cookies.txt
          git commit -m "Add screenshot from YouTube video"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
