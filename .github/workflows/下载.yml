name: youtube

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Enter YouTube video URL'
        required: true
        default: 'https://youtu.be/sample_video'
      media_choice:
        description: 'ðŸ“º é€‰æ‹©åª’ä½“ç±»åž‹ (è§†é¢‘ã€éŸ³é¢‘æˆ–è§†é¢‘+éŸ³é¢‘)'
        required: true
        type: choice
        options:
          - '720p'
          - '1080p'
          - '1440p'
          - '4K'
          - '8K'
          - '720p + éŸ³é¢‘'
          - '1080p + éŸ³é¢‘'
          - '4K + éŸ³é¢‘'
          - '8K + éŸ³é¢‘'
          - 'åªæœ‰éŸ³é¢‘'
        default: '1080p + éŸ³é¢‘'
      enable_sections:
        description: 'Enable video section trimming?'
        required: false
        type: choice
        options: 
          - 'false'
          - 'true'
        default: 'false'
      start_time:
        description: 'Start time (if section trimming is enabled)'
        required: false
        default: '0:00'
      end_time:
        description: 'End time (if section trimming is enabled)'
        required: false
        default: '2:00'

jobs:
  get_screenshot:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install yt-dlp and ffmpeg
        run: |
          pip install yt-dlp
          sudo apt-get update && sudo apt-get install -y ffmpeg
      
      - name: èŽ·å–è§†é¢‘å’ŒéŸ³é¢‘æµç¼–å·
        run: |
          yt-dlp -F ${{ github.event.inputs.video_url }} > formats.txt

          # è§£æžç”¨æˆ·é€‰æ‹©çš„åª’ä½“ç±»åž‹
          MEDIA_CHOICE="${{ github.event.inputs.media_choice }}"

          if [[ "$MEDIA_CHOICE" == *"+ éŸ³é¢‘"* ]]; then
            # é€‰æ‹©è§†é¢‘åˆ†è¾¨çŽ‡éƒ¨åˆ†
            RES=$(echo "$MEDIA_CHOICE" | sed 's/ + éŸ³é¢‘//')
            VIDEO_STREAM_ID=$(grep -E "${RES}" formats.txt | grep https | sort -k6 -nr | head -n 1 | awk '{print $1}')
            # é€‰æ‹©æœ€å¤§æ–‡ä»¶çš„éŸ³é¢‘æµ
            AUDIO_STREAM_ID=$(grep 'audio only' formats.txt | grep https | sort -k6 -nr | head -n 1 | awk '{print $1}')
            echo "é€‰å®šè§†é¢‘æµç¼–å·: $VIDEO_STREAM_ID"
            echo "é€‰å®šéŸ³é¢‘æµç¼–å·: $AUDIO_STREAM_ID"
            echo "VIDEO_STREAM_ID=$VIDEO_STREAM_ID" >> $GITHUB_ENV
            echo "AUDIO_STREAM_ID=$AUDIO_STREAM_ID" >> $GITHUB_ENV

          elif [[ "$MEDIA_CHOICE" == "åªæœ‰éŸ³é¢‘" ]]; then
            # åªé€‰æ‹©éŸ³é¢‘æµ
            AUDIO_STREAM_ID=$(grep 'audio only' formats.txt | grep https | sort -k6 -nr | head -n 1 | awk '{print $1}')
            echo "é€‰å®šéŸ³é¢‘æµç¼–å·: $AUDIO_STREAM_ID"
            echo "AUDIO_STREAM_ID=$AUDIO_STREAM_ID" >> $GITHUB_ENV

          else
            # åªé€‰æ‹©è§†é¢‘æµ
            RES=$MEDIA_CHOICE
            VIDEO_STREAM_ID=$(grep -E "${RES}" formats.txt | grep https | sort -k6 -nr | head -n 1 | awk '{print $1}')
            echo "é€‰å®šè§†é¢‘æµç¼–å·: $VIDEO_STREAM_ID"
            echo "VIDEO_STREAM_ID=$VIDEO_STREAM_ID" >> $GITHUB_ENV
          fi
      
      - name: ä¸‹è½½è§†é¢‘å’ŒéŸ³é¢‘
        run: |
          if [[ "$MEDIA_CHOICE" == *"+ éŸ³é¢‘"* ]]; then
            # ä¸‹è½½è§†é¢‘ + éŸ³é¢‘å¹¶è¿›è¡Œåˆå¹¶
            yt-dlp --cookies cookies.txt -f $VIDEO_STREAM_ID+$AUDIO_STREAM_ID \
            $([[ "${{ github.event.inputs.enable_sections }}" == "true" ]] && echo "--download-sections *${{ github.event.inputs.start_time }}-${{ github.event.inputs.end_time }}") \
            -o "downloads/%(id)s.%(ext)s" ${{ github.event.inputs.video_url }}
          elif [[ "$MEDIA_CHOICE" == "åªæœ‰éŸ³é¢‘" ]]; then
            # ä¸‹è½½éŸ³é¢‘
            yt-dlp --cookies cookies.txt -f $AUDIO_STREAM_ID \
            $([[ "${{ github.event.inputs.enable_sections }}" == "true" ]] && echo "--download-sections *${{ github.event.inputs.start_time }}-${{ github.event.inputs.end_time }}") \
            -o "downloads/%(id)s.%(ext)s" ${{ github.event.inputs.video_url }}
          else
            # åªä¸‹è½½è§†é¢‘
            yt-dlp --cookies cookies.txt -f $VIDEO_STREAM_ID \
            $([[ "${{ github.event.inputs.enable_sections }}" == "true" ]] && echo "--download-sections *${{ github.event.inputs.start_time }}-${{ github.event.inputs.end_time }}") \
            -o "downloads/%(id)s.%(ext)s" ${{ github.event.inputs.video_url }}
          fi
      
      - name: èŽ·å–ä¸‹è½½æ–‡ä»¶çš„è·¯å¾„
        run: |
          FILE_PATH=$(ls downloads/*)
          echo "ä¸‹è½½çš„æ–‡ä»¶è·¯å¾„: $FILE_PATH"
          echo "FILE_PATH=$FILE_PATH" >> $GITHUB_ENV
      
      - name: Upload screenshot as artifact
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-videos
          path: downloads/**
      
      - name: Capture screenshot at 5 seconds
        run: ffmpeg -i ${{ env.FILE_PATH }} -ss 5 -vframes 1 -y screenshot.png

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Commit and push screenshot to repository
        run: |
          git add screenshot.png 
          git commit -a -m "Add screenshot from YouTube video"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
