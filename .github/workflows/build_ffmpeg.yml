name: Build Minimal FFmpeg for Android

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.5

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt update
          sudo dpkg --add-architecture i386
          sudo apt update
          sudo apt install -y build-essential autoconf automake libtool git pkg-config make curl unzip zlib1g-dev yasm \
                                 libc6:i386 libncurses5:i386 libstdc++6:i386 lib32z1 libbz2-1.0:i386 gcc-multilib g++-multilib 

      - name: Cache NDK
        uses: actions/cache@v3
        with:
          path: ${{ runner.temp }}/ndk
          key: ndk-r16b

      - name: Download NDK (r16b)
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          mkdir ${{ runner.temp }}/ndk && cd ${{ runner.temp }}/ndk
          curl -LO https://dl.google.com/android/repository/android-ndk-r16b-linux-x86_64.zip
          unzip android-ndk-r16b-linux-x86_64.zip
          echo "ANDROID_NDK_HOME=${{ runner.temp }}/ndk/android-ndk-r16b" >> $GITHUB_ENV

      - name: Download FFmpeg source
        run: |
          curl -LO https://ffmpeg.org/releases/ffmpeg-6.1.1.tar.xz
          tar -xf ffmpeg-6.1.1.tar.xz
          cd ffmpeg-6.1.1

      - name: Configure FFmpeg (minimal)
        run: |
          cd ffmpeg-6.1.1
          export CFLAGS="-I${ANDROID_NDK_HOME}/sysroot/usr/include -I${ANDROID_NDK_HOME}/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/include"  # 添加 CFLAGS
          export LDFLAGS="-L${ANDROID_NDK_HOME}/sysroot/usr/lib/arm-linux-androideabi -L${ANDROID_NDK_HOME}/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/lib/gcc/arm-linux-androideabi/4.9.x"  # 添加 LDFLAGS
          ./configure \
            --target-os=android \
            --arch=armv7a \
            --enable-cross-compile \
            --cross-prefix="${ANDROID_NDK_HOME}/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-" \
            --sysroot="${ANDROID_NDK_HOME}/platforms/android-21/arch-arm" \
            --cc="${ANDROID_NDK_HOME}/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-gcc" \
            --cxx="${ANDROID_NDK_HOME}/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-g++" \
            --prefix="$GITHUB_WORKSPACE/build" \
            --disable-everything \
            --enable-decoder=mpeg4 \
            --enable-shared \
            --disable-asm

      - name: Build FFmpeg
        run: |
          cd ffmpeg-6.1.1
          make -j $(nproc)

      - name: Install FFmpeg
        run: make install

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-build-minimal
          path: build/